{% extends 'users/base_manager.html' %}

{% block title %}Manager Reports{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="mb-4">Reports Dashboard</h2>

  <!-- ----------------------------- -->
  <!-- Date Filters -->
  <!-- ----------------------------- -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="start_date" class="form-label">Start Date</label>
      <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col-md-3">
      <label for="end_date" class="form-label">End Date</label>
      <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col-md-3 align-self-end">
      <button type="submit" class="btn btn-primary">Filter Reports</button>
    </div>
  </form>

  <!-- ----------------------------- -->
  <!-- Tabs Navigation -->
  <!-- ----------------------------- -->
  <ul class="nav nav-tabs" id="reportsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">Inventory</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button">Stock Movement</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button">Sales</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button">Financial</button>
    </li>
  </ul>

  <!-- ----------------------------- -->
  <!-- Tabs Content -->
  <!-- ----------------------------- -->
  <div class="tab-content mt-3">

    <!-- Inventory Tab -->
    <div class="tab-pane fade show active" id="inventory" role="tabpanel">
      <h5>Current Inventory Levels</h5>
      <div class="table-responsive mb-3">
        <table class="table table-bordered table-striped">
          <thead class="table-secondary">
            <tr>
              <th>Product</th>
              <th>Warehouse</th>
              <th>Quantity</th>
              <th>Batch Number</th>
              <th>Expiry Date</th>
            </tr>
          </thead>
          <tbody>
            {% for item in inventory %}
            <tr {% if item.quantity < item.product.min_quantity %} class="table-danger" {% endif %}>
              <td>{{ item.product.name }}</td>
              <td>{{ item.warehouse.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.batch_number }}</td>
              <td>{{ item.expiry_date|date:"Y-m-d" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center">No inventory available</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h5>Low Stock Alerts</h5>
      <ul>
        {% for item in inventory %}
          {% if item.quantity < item.product.min_quantity %}
            <li>{{ item.product.name }} in {{ item.warehouse.name }}: Only {{ item.quantity }} left</li>
          {% endif %}
        {% empty %}
          <li>No low stock alerts</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Stock Movement Tab -->
    <div class="tab-pane fade" id="stock" role="tabpanel">
      <h5>Received Stock</h5>
      <div class="table-responsive mb-3">
        <table class="table table-striped table-bordered">
          <thead class="table-success">
            <tr>
              <th>Product</th>
              <th>Warehouse</th>
              <th>Quantity</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for item in received_stock %}
            <tr>
              <td>{{ item.product.name }}</td>
              <td>{{ item.warehouse.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No received stock</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h5>Sold Stock</h5>
      <div class="table-responsive mb-3">
        <table class="table table-striped table-bordered">
          <thead class="table-danger">
            <tr>
              <th>Product</th>
              <th>Warehouse</th>
              <th>Quantity</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for item in sold_stock %}
            <tr>
              <td>{{ item.product.name }}</td>
              <td>{{ item.warehouse.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No sold stock</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h5>Stock Movement Trends</h5>
      <canvas id="stockTrendsChart" height="300"></canvas>
    </div>

    <!-- Sales Tab -->
    <div class="tab-pane fade" id="sales" role="tabpanel">
      <h5>Sales by Product</h5>
      <canvas id="salesByProductChart" height="300"></canvas>
    </div>

    <!-- Financial Tab -->
    <div class="tab-pane fade" id="financial" role="tabpanel">
      <h5>Total Revenue</h5>
      <p>${{ total_revenue|default:"0.00" }}</p>

      <h5>Profit Margins</h5>
      <canvas id="profitMarginChart" height="300"></canvas>

      <h5>Top Selling Products</h5>
      <canvas id="topProductsChart" height="300"></canvas>
    </div>

  </div> <!-- tab-content -->
</div> <!-- container -->

<!-- ----------------------------- -->
<!-- Scripts -->
<!-- ----------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JSON-safe data -->
<script id="chart-data" type="application/json">
  {
    "stockTrendsLabels": {{ stock_trends_labels|json_script:"stockTrendsLabels" }},
    "stockReceivedData": {{ stock_received_data|json_script:"stockReceivedData" }},
    "stockSoldData": {{ stock_sold_data|json_script:"stockSoldData" }},
    "salesByProductLabels": {{ sales_product_labels|json_script:"salesByProductLabels" }},
    "salesByProductData": {{ sales_product_data|json_script:"salesByProductData" }},
    "profitMarginLabels": {{ profit_margin_labels|json_script:"profitMarginLabels" }},
    "profitMarginData": {{ profit_margin_data|json_script:"profitMarginData" }},
    "topProductsLabels": {{ top_products_labels|json_script:"topProductsLabels" }},
    "topProductsData": {{ top_products_data|json_script:"topProductsData" }}
  }
</script>

<script>
  // Parse JSON data for charts
  const stockTrendsLabels = JSON.parse(document.getElementById('stockTrendsLabels').textContent);
  const stockReceivedData = JSON.parse(document.getElementById('stockReceivedData').textContent);
  const stockSoldData = JSON.parse(document.getElementById('stockSoldData').textContent);

  const salesByProductLabels = JSON.parse(document.getElementById('salesByProductLabels').textContent);
  const salesByProductData = JSON.parse(document.getElementById('salesByProductData').textContent);

  const profitMarginLabels = JSON.parse(document.getElementById('profitMarginLabels').textContent);
  const profitMarginData = JSON.parse(document.getElementById('profitMarginData').textContent);

  const topProductsLabels = JSON.parse(document.getElementById('topProductsLabels').textContent);
  const topProductsData = JSON.parse(document.getElementById('topProductsData').textContent);

  // Stock Movement Chart
  new Chart(document.getElementById('stockTrendsChart'), {
    type: 'line',
    data: {
      labels: stockTrendsLabels,
      datasets: [
        { label: 'Stock Received', data: stockReceivedData, borderColor: 'rgba(54, 162, 235, 1)', fill: false },
        { label: 'Stock Sold', data: stockSoldData, borderColor: 'rgba(255, 99, 132, 1)', fill: false }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Sales by Product Chart
  new Chart(document.getElementById('salesByProductChart'), {
    type: 'line',
    data: { labels: salesByProductLabels, datasets: [{ label: 'Units Sold', data: salesByProductData, borderColor: 'rgba(255, 206, 86, 1)', fill: false }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Profit Margin Chart
  new Chart(document.getElementById('profitMarginChart'), {
    type: 'bar',
    data: { labels: profitMarginLabels, datasets: [{ label: 'Profit ($)', data: profitMarginData, backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });

  // Top Selling Products Chart
  new Chart(document.getElementById('topProductsChart'), {
    type: 'line',
    data: { labels: topProductsLabels, datasets: [{ label: 'Units Sold', data: topProductsData, borderColor: 'rgba(255, 159, 64, 1)', fill: false }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
</script>
{% endblock %}
